From 42570b1c93f85015b595d00ad2e42842947f32a4 Mon Sep 17 00:00:00 2001
From: Filip Jagodzinski <filip.jagodzinski@arm.com>
Date: Tue, 25 Jun 2024 12:57:33 +0000
Subject: [PATCH 2/3] app-version: Do not store version in a global var

Storing the component image version in a single variable makes
multi-component setup impossible to handle correctly.

Update the image version getter to write the component version to an
output param.

Signed-off-by: Filip Jagodzinski <filip.jagodzinski@arm.com>
---
 version/application_version.c | 15 ++++++++-------
 version/application_version.h | 11 +++++------
 2 files changed, 13 insertions(+), 13 deletions(-)

diff --git a/version/application_version.c b/version/application_version.c
index 7b38c6a..428bb9a 100644
--- a/version/application_version.c
+++ b/version/application_version.c
@@ -27,30 +27,31 @@
  */
 
 /* C Runtime includes. */
+#include <assert.h>
 #include <stdlib.h>
 
 /* Amazon FreeRTOS include. */
 #include "FreeRTOS.h"
 #include "application_version.h"
 
-AppVersion32_t appFirmwareVersion;
-
-int GetImageVersionPSA( psa_fwu_component_t uxComponent )
+int GetImageVersionPSA( psa_fwu_component_t uxComponent, AppVersion32_t *pxVersion )
 {
     psa_fwu_component_info_t xComponentInfo = { 0 };
     psa_status_t uxStatus;
 
+    assert( pxVersion != NULL );
+
     uxStatus = psa_fwu_query( uxComponent, &xComponentInfo );
     if( uxStatus == PSA_SUCCESS )
     {
-        appFirmwareVersion.u.x.major = xComponentInfo.version.major;
-        appFirmwareVersion.u.x.minor = xComponentInfo.version.minor;
-        appFirmwareVersion.u.x.build = (uint16_t)xComponentInfo.version.build;
+        pxVersion->u.x.major = xComponentInfo.version.major;
+        pxVersion->u.x.minor = xComponentInfo.version.minor;
+        pxVersion->u.x.build = (uint16_t)xComponentInfo.version.build;
         return 0;
     }
     else
     {
-        appFirmwareVersion.u.signedVersion32 = 0;
+        pxVersion->u.signedVersion32 = 0;
         return -1;
     }
 }
diff --git a/version/application_version.h b/version/application_version.h
index 7775910..99f9b99 100644
--- a/version/application_version.h
+++ b/version/application_version.h
@@ -30,16 +30,15 @@
 /**
  * @brief Get the running image version of the given component.
  *
- * Get the image version by PSA Firmware update service API and assign it to xAppFirmwareVersion
- * which is use in the ota agent.
+ * Get the image version by PSA Firmware update service API and assign it to pxVersion.
  *
  * @note portALLOCATE_SECURE_CONTEXT( 0 ) should be called before this function, otherwise this function
  * will always fail.
- * @param[in] N/A.
+ * @param[in] uxComponent Firmware component for which information is requested.
+ * @param[out] pxVersion Output parameter for version information. On failure this is set to 0.
  *
- * @return 0 on success and the xAppFirmwareVersion is assigned with the value read from the Firmware
- * update service. -1 on failure and the xAppFirmwareVersion is 0.
+ * @return 0 on success and -1 on failure.
  */
-int GetImageVersionPSA( psa_fwu_component_t uxComponent );
+int GetImageVersionPSA( psa_fwu_component_t uxComponent, AppVersion32_t *pxVersion );
 
 #endif
-- 
2.45.2

